<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
        <title>Symbols on polylines</title>
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript">

         var map, timer;
         var offset = {};
         var tracks
         var unlock = false;

         
         Array.prototype.sortBy = function(p) {
             return this.slice(0).sort(function(a,b) {
                 return (a[p] > b[p]) ? 1 : (a[p] < b[p]) ? -1 : 0;
             });
         }
         
         function initialize() {
             window.coord_list = [];
             var obj = [];
             var sorted_obj = [];
             var map = new google.maps.Map(document.getElementById('map'), {
                 center: {lat: 37.46, lng: 121.448},
                 zoom: 5,
                 mapTypeId: google.maps.MapTypeId.ROADMAP
             });

             $('#start_sim').click(function(){
                 sorted_obj = obj.sortBy('date');

                 var geocoder = new google.maps.Geocoder();
                 
                 for (var i = sorted_obj.length-1; i >= 0; i--) {
                     geocodeAddress(geocoder, map, sorted_obj[i]['from']);
                     geocodeAddress(geocoder, map, sorted_obj[i]['to']);
                 };

                 console.log(sorted_obj.length);
                 
                 setTimeout(function(){
                     tracks = new google.maps.Polyline({ 
                         // path : [kaifeng, shanghai, nagoya, sapporo,kyoto,shanghai, kaifeng],
                         path : coord_list,
                         geodesic: true,
                         strokeOpacity: 1.0,
                         strokeWeight: 0.05,
                         icons: [{
                             icon: {
                                 path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                 // path: "jpg/airplane.png",
                                 strokeColor: 'red',
                                 strokeOpacity: 1.0,
                                 strokeWeight: 1,
                                 fillColor: 'blue',
                                 fillOpacity: 1.0,
                                 scale: 1
                             },
                             repeat: '10%',
                             offset: '5%'
                         }],
                         map: map,
                     });    
                     
                     offset = {
                         'tracks': 0,
                     }
                     
                     start();
                     $(this).attr('disabled','disabled');
                     $('#terminate_sim').prop("disabled", false);
                 }, 3000);                 
             });

             $('#terminate_sim').click(function(){
                 stop();
                 $(this).attr('disabled','disabled');
                 $('#start_sim').prop("disabled", false);
             });

             $('#datetimepicker').datetimepicker();

             $('#add').click(function(){
                 event.preventDefault(); // stop default behaviour of submit button
                 from = $('#from').val();
                 to = $('#to').val();
                 date = $('#datetimepicker').val();

                 var match = date.match(/^(\d+)\/(\d+)\/(\d+) (\d+)\:(\d+)$/);        
                 var dat = new Date(match[1], match[2] - 1, match[3], match[4], match[5]);

                 obj.push({"from":from, "to":to, "date":dat}); 
                 
                 // add new list item
                 $('#list').prepend('<li> ' + from +'->' + to + ' : ' + date + '<a href="#" class="itemDelete"> D </a>' + '</li>');
                 // clear value input
                 $('#from').val('');
                 $('#to').val('');
                 $('#datetimepicker').val('');                 
             });

             $('#list').on('click', '.itemDelete', function() {
                 $(this).closest('li').remove();
             });
         }

         function start() {
             timer = setInterval(function() {
                 animateTracks();
                 console.log("start loop");
             }, 500);
         }

         function stop() {
             clearInterval(timer);
         }

         function animateTracks() {
             if (offset['tracks'] == 9) {
                 offset['tracks'] = 0;
             } else {
                 offset['tracks']++;
             }
             var icons = tracks.get('icons');
             icons[0].offset = offset['tracks'] + '%';
             tracks.set('icons', icons); 
         }

         function geocodeAddress(geocoder, resultsMap, address) {
             // var address = document.getElementById('address').value;
             var tttt = [];
             var lat = 0;
             var lng = 0;
             var tt = "";
             geocoder.geocode({'address': address}, function(results, status) {
                 if (status === google.maps.GeocoderStatus.OK) {
                     coord_list.push(new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng()));
                 } else {
                     alert('Geocode was not successful for the following reason: ' + status);
                 }
             });
             console.log(tt);
             console.log(lat.toString() + " 202");
             console.log(lng.toString() + " 203");
             console.log(tttt);
             console.log(tttt[0] + " 205");
             return {'lat':lat, 'lng':lng};
         }

        </script>
        <style>
         #map {
             width: 85%;
             height: 100%;
             position: absolute;
             background-color: white;
             border: 1px solid black;
         }
         #container{
             width: 15%;
             height: 100%;
             position : relative;
             float : right;
         }
         
         #start_sim{
             float : left;
             position : relative;
             width : 95%;
             height : 30px;
         }

         #terminate_sim{
             float : left;
             position : relative;
             width : 95%;
             height : 30px;             
         }

         .form-control{
             float : left;
             position : relative;
             width : 99%;
             height : 30px;                          
         }
         #add{
             float : left;
         }
         #list{
             position : relative;
             float : left;
         }
        </style>
    </head>
    <body onload="initialize()">
        <div id="map"></div>
        <div id="container">
            <button type="button" class="btn btn-default" id="start_sim">Start Simulation</button>
            <button type="button" class="btn btn-default" id="terminate_sim">Terminate Simulation</button>
            <form class="form-inline">
                <input class="form-control" type="text" id ="from" placeholder ="From ...">
                <input class="form-control" type="text" id ="to" placeholder ="To ...">
                <input class="form-control" id="datetimepicker" type="text" >                
                <button class="btn btn-default" id ="add">Add Item</button>
            </form>
            <ul id="list"></ul>
        </div>
    </body>
    <link rel="stylesheet" type="text/css" href="js/datetimepicker/jquery.datetimepicker.css">
    <script src="js/datetimepicker/jquery.js"></script>
    <script src="js/datetimepicker/jquery.datetimepicker.js"></script>
</html>
